
<div class="kontrolilo">

  <div class="stato">
    pretiĝanta
  </div>

  <form class="formo" hidden>
    <textarea name="teksto" placeholder="enigi tekston ĉie tie"></textarea>
    <button type="submit">ek</button>
    <button type="button" name="mp">malplenigi</button>
  </form>

  <div class="rezulto" hidden>
  </div>

  <div class="lavorto" hidden>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let ilo = null

  let e0 = document.querySelector('.kontrolilo')
  let eS = e0.querySelector('.stato')
  let eF = e0.querySelector('form')
  let eT = eF.querySelector('[name=teksto]')
  let eR = e0.querySelector('.rezulto')
  let eM = e0.querySelector('.lavorto')

  function pretigu(o) {
    ilo = o
    montruTeksto(eS)

    eF.addEventListener('submit', e  => {
      e.preventDefault()
      komprenu(eT.value)
    })
    eF.querySelector("[name=mp]").addEventListener('click', e  => {
      eT.value = ''
    })

    komprenu(eT.value)
    eF.hidden = false
  }

  const dividŜablono = /[^-A-Za-zĉĝĥĵŝŭĈĜĤĴŜŬ]/

  function komprenu(teksto) {
    malplenigu(eR)

    if (!teksto) {
      eR.hidden = true
      eM.hidden = true
      return
    }

    let uzatajRadikoj = new Map()

    let lasteMarkita = null
    function markuUzoj(radiko) {
      if (lasteMarkita) {
        for (let v of lasteMarkita.vortoj) {
          v.classList.remove('markita')
        }
      }
      for (let v of radiko.vortoj) {
        v.classList.add('markita')
      }
      lasteMarkita = radiko
    }

    let e = document.createElement('div')
    for (v of teksto.split(dividŜablono)) {
      if (v.length == 0) {
        continue
      }
      let vs = mkel('span')

      let divRez = ilo.komprenuVorton(v.toLowerCase())
      let bonaj = divRez.bonaj
      let malbonaj = divRez.malbonaj

      let unua = bonaj[0]
      if (!unua) {
        unua = malbonaj[0]
      }

      // kio estas la entuta nivelo?
      vs.textContent = unua.vorto
      if (bonaj.length > 1) {
        vs.textContent += ` (${bonaj.length})`
      }
      if (unua.eraro) {
        vs.title = unua.eraro.join(', ')
        vs.classList.add('warn')
      } else {
        vs.classList.add('nivelo-' + unua.nivelo)
      }
      vs.addEventListener('click', () => montruVorto(bonaj, divRez.malbonaj))
      e.append(vs, ' ')

      if (unua.eroj) {
        for (let x of unua.eroj) {
          let r = uzatajRadikoj.get(x.r)
          if (!r) {
            r = {
              radiko: x.o,
              vortoj: []
            }
            uzatajRadikoj.set(x.r, r)
          }
          r.vortoj.push(vs)
        }
      }
    }
    eR.append(e)

    let e2 = document.createElement('div')
    for (let x of [...uzatajRadikoj.values()].sort((a, b) => eoCompare(a.radiko.radiko, b.radiko.radiko))) {
      let vs = mkel('span', { classes: [ 'nivelo-' + x.radiko.nivelo ] })
      vs.append(x.radiko.radiko)
      vs.addEventListener('mouseover', e => {
        markuUzoj(x)
      })
      vs.addEventListener('click', e => {
        montruRadiko(x.radiko)
      })
      e2.append(vs, ' ')
    }
    eR.append(e2)

    eR.hidden = false
  }

  function montruVorto(bonaj, malbonaj) {
    malplenigu(eM)

    if (bonaj.length > 0) {
      let l = document.createElement('ol')
      for (let a of bonaj) {
        let ero = document.createElement('li')
        ero.textContent = a.vorto
        if (a.eraro) {
          ero.title = a.eraro.join(', ')
        }
        l.append(ero)
      }
      eM.append(l)
    }

    if (malbonaj.length > 0) {
      let l = document.createElement('ol')
      l.classList.add('warn')
      for (let a of malbonaj) {
        let ero = document.createElement('li')
        ero.textContent = a.vorto
        if (a.eraro) {
          ero.title = a.eraro.join(', ')
        }
        l.append(ero)
      }
      eM.append(l)
    }

    eM.hidden = false
    montru(eM)
  }

  eo('{{ print .Site.Params.VortaroURL }}').
  then(
    o => pretigu(o),
    e => montruEraro(eS, e))
})
</script>
